var Util = function() {
    return {
        // == Get the child index from an array of children elements.
        childIndex: function(child, children) {
            var numberOfChildren = children.length;
            for (var i = 0; i < numberOfChildren; ++i) {
                if (child === children[i]) {
                    return i;
                }
            }
        },

        // == Check if an element has a given class name.
        hasClass: function(element, className) {
            return (' ' + element.className + ' ').indexOf(' ' + className + ' ') > -1;
        },

        // == Check if an element doesn't have a given class.
        doesntHaveClass: function(element, className) {
            var Util = this;
            return ! Util.hasClass(element, className);
        },

        // == Get a random item from an array.
        randomItem: function(array) {
            var Util = this;
            return array[Util.randomNumber(array.length)];
        },

        // == Remove a class from an element.
        removeClass: function(element, className) {
            var Util = this;
            if (Util.hasClass(element, className)) {
                element.classList.remove(className);
            }
        },

        // == Shuffle an array. Taken from: http://stackoverflow.com/a/6274381
        shuffleArray: function(a) {
            var Util = this;
            var j, x, i;

            for (i = a.length; i; i--) {
                j = Util.randomNumber(i);
                x = a[i - 1];
                a[i - 1] = a[j];
                a[j] = x;
            }

            return a;
        },

        randomNumber: function(num) {
            var number = Math.floor(Math.random() * num);
            
            if (number === 0) {
                return 1;
            }

            return number;
        }
    }
}();
var EventHandler = function () {
    var id = 0, listeners = [];

    return {
        addListener: function(event, handler, element) {
            id++;
            element.addEventListener(event, handler);
            
            listeners[id] = {
                event: event,
                handler: handler,
                element: element
            };
            
            return id;
        },

        removeListener: function(id) {            
            if (id in listeners) {
                var handler = listeners[id];
                handler.element.removeEventListener(handler.event, handler.handler);
                delete listeners[id];
            }
        }
    }
}();
function Space() {
    this.canvas = document.getElementById("space");
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    this.ctx = this.canvas.getContext("2d");
    
    this.starsPerGalaxy = 250;
    this.numberOfGalaxies = 15;
    this.maxGalaxySize = { xRad: 150, yRad: 100 };
    this.maxStarSize = 2;
    this.numberOfStars = 4000;
}

Space.prototype.make = function() {
    var Space = this;
    var numberOfStars = Space.numberOfStars;
    var numberOfGalaxies = Space.numberOfGalaxies;

    for(var i=0; i < numberOfStars; i++) {
        Space.star();
    }    

    for(var i=0; i < numberOfGalaxies; i++) {
        Space.galaxy();
    }
};

Space.prototype.star = function(x=null, y=null) {
    var Space = this;
    var ctx = Space.ctx;
    var canvas = Space.canvas;

    var r = Util.randomNumber(Space.maxStarSize);

    if (x === null) {
        var x = Util.randomNumber(canvas.width);    
    }

    if (y === null) {
        var y = Util.randomNumber(canvas.height);
        ctx.beginPath();
    }

    ctx.fillStyle = "rgba(255, 255, 255," + 1 / Util.randomNumber(10) + ")";
    ctx.beginPath();
    ctx.arc(x, y, r, 0, 2 * Math.PI, true);
    ctx.closePath();
    ctx.fill();
};

Space.prototype.galaxy = function() {
    var Space = this;
    var x = Util.randomNumber(Space.canvas.width);
    var y = Util.randomNumber(Space.canvas.height);
    var xRad = Util.randomNumber(Space.maxGalaxySize.xRad);
    var yRad = Util.randomNumber(Space.maxGalaxySize.yRad);

    Space.galaxyStars(x, y, xRad, yRad);
};

Space.prototype.galaxyStars = function(x, y, xRad, yRad) {
    var Space = this;
    var ctx = Space.ctx;
    var xGalaxyCenter = x;
    var yGalaxyCenter = y;
    var xAmount, yAmount;
    
    for(var i=0; i < Space.starsPerGalaxy; i++) {
        xAmount = Util.randomNumber(xRad);
        if (Util.randomNumber(2) === 0) { xAmount = -Math.abs(xAmount); }
        x = (xGalaxyCenter + xAmount * yRad / yAmount) / Math.tan(xRad);
        
        yAmount = Util.randomNumber(yRad);
        if (Util.randomNumber(2) === 0) { yAmount = -Math.abs(yAmount); }
        y = (yGalaxyCenter + yAmount * xRad / xAmount) / Math.tan(yRad);
        
        ctx.moveTo(x, y);
        Space.star(x, y);
    }
};
function Vector(element) {
    this.element = element;
}

Vector.prototype.north = function() {
    var Vector = this;
    var vectorCell = Vector.element.parentElement;
    var vectorRow = vectorCell.parentElement;
    var vectorRowChildren = vectorRow.children;
    var vectorIndex = Util.childIndex(vectorCell, vectorRowChildren);
    var previousRow = vectorRow.previousElementSibling;

    if (previousRow) {
        return previousRow.children[vectorIndex];    
    }

    // == First row.
    return null;
}

Vector.prototype.east = function() {
    var Vector = this;
    return Vector.element.parentElement.nextElementSibling;
}

Vector.prototype.south = function() {
    var Vector = this;
    var vectorCell = Vector.element.parentElement;
    var vectorRow = vectorCell.parentElement;
    var vectorRowChildren = vectorRow.children;
    var vectorIndex = Util.childIndex(vectorCell, vectorRowChildren);
    var nextRow = vectorRow.nextElementSibling;

    if (nextRow) {
        return nextRow.children[vectorIndex];    
    }

    // == Last row.
    return null;
}

Vector.prototype.west = function() {
    var Vector = this;
    return Vector.element.parentElement.previousElementSibling;
}
function Move(element) {
    this.element = element;
}

Move.prototype.direction = function(keyCode) {
    var Move = this;

    switch(keyCode) {
        case 38: 
            Move.north(new Vector(Move.element));
            break;
        case 39:
            Move.east(new Vector(Move.element));
            break;
        case 40:
            Move.south(new Vector(Move.element));
            break;
        case 37:
            Move.west(new Vector(Move.element));
            break;
    }
}

Move.prototype.north = function(vector) {
    if (vector.north()) {
        vector.north().appendChild(vector.element);
    }
};

Move.prototype.east = function(vector) {
    if (vector.east()) {
        vector.east().appendChild(vector.element);
    }
};

Move.prototype.south = function(vector) {
    if (vector.south()) {
        vector.south().appendChild(vector.element);
    }
};

Move.prototype.west = function(vector) {
    if(vector.west()) {
        vector.west().appendChild(vector.element);    
    }
};
function Painter(element) {
    this.element = element;
    this.paintClass = 'painted';
    this.npcPaintClass = 'npc-painted';
}

Painter.prototype.paint = function() {
    var Painter = this;

    Painter.removePaint(Painter.npcPaintClass);

    if (Util.doesntHaveClass(Painter.element.parentElement, Painter.paintClass)) {
        Painter.element.parentElement.className += ' ' + Painter.paintClass;
    }
};

Painter.prototype.removePaint = function(paintClass) {
    Util.removeClass(this.element.parentElement, paintClass);
};

Painter.prototype.npcPaint = function() {
    var Painter = this;

    Painter.removePaint(Painter.paintClass);

    if (Util.doesntHaveClass(Painter.element.parentElement, Painter.npcPaintClass)) {
        Painter.element.parentElement.className += ' ' + Painter.npcPaintClass;
    }
};

Painter.prototype.isPaintable = function (element, character) {
    var Painter = this;
    var paint;

    if (character instanceof Npc) {
        paint = Painter.npcPaintClass;
    }

    if (character instanceof Player) {
        paint = Painter.paintClass;
    }

    return Util.doesntHaveClass(element, paint);
};

function Character(id) {
    this.element = document.getElementById(id);
    this.move = new Move(this.element);
    this.painter = new Painter(this.element);
}
function Player(Character) {
    this.character = Character;
    this.score = document.getElementById("player-score");
    this.movement = {
            keys: [38, 39, 40, 37], // == Arrow keys
            handlers: []
        };
}

Player.prototype.play = function() {
    var Player = this;
    Player.enableMovement();
};

Player.prototype.enableMovement = function() {
    var Player = this;
    var longPress = true;
    var movement = Player.movement;

    // == Add event listener for arrow key down.
    movement.handlers.push(
        EventHandler.addListener("keydown", function(e) {
            // == If an arrowkey was pressed.
            if (movement.keys.indexOf(e.keyCode) > -1) { 
                // == Prevent default behavior.
                e.preventDefault();

                // == Don't move player if holding down arrow key.
                if (! longPress) {
                    return e.keyCode;
                }

                // == Disable long press.
                longPress = false;

                // == Move the player.
                Player.character.move.direction(e.keyCode);
                
                // == Paint the square.
                Player.character.painter.paint();

                // == Update the score.
                Player.updateScore();
            }
        }, window)
    );

    // == Add event listener for arrow key up.
    movement.handlers.push(
        EventHandler.addListener("keyup", function(e) {
            // == If an arrowkey was released.
            if (movement.keys.indexOf(e.keyCode) > -1) { 
                // == Turn long press back on.
                longPress = true;
            }
        }, window)
    );
}

Player.prototype.disableMovement = function () {
    var Player = this;
    var numOfMovementHandlers = Player.movement.handlers.length;

    // == Remove all movement event listeners.
    for(i=0; i < numOfMovementHandlers; i++) {
        EventHandler.removeListener(Player.movement.handlers[i]);
    }
}

Player.prototype.currentScore = function() {
    return document.getElementsByClassName("painted").length;
}

Player.prototype.updateScore = function() {
    var Player = this;
    Player.score.innerHTML = Player.currentScore();
}

Player.prototype.stop = function() {
    var Player = this;
    Player.disableMovement();
}
function Npc(Character) {
    this.character = Character;
    this.vector = new Vector;
    this.arrowKeys = [38, 39, 40, 37];

    this.speed = 105; // == in milliseconds
    this.score = document.getElementById("npc-score");
    this.playing = null;
}

Npc.prototype.play = function() {
    var Npc = this;

    Npc.playing = setInterval(function() {
        Npc.move();
        Npc.character.painter.npcPaint();
        Npc.updateScore();
    }, Npc.speed);
};

Npc.prototype.move = function() {
    var Npc = this;

    var direction = Npc.look(Npc.character.element);

    if (direction === false) {
        Npc.moveRandom();
    }

    else {
        Npc.character.move.direction(direction);    
    }
};

Npc.prototype.look = function(element) {
    var Npc = this;
    var numOfDirections = Npc.arrowKeys.length;
    var arrowKeys = Util.shuffleArray(Npc.arrowKeys);

    for(var i=0; i < numOfDirections; i++) {
        var isPaintable = Npc.isPaintable(element, arrowKeys[i]);

        if (isPaintable) {
            return arrowKeys[i];
        }
    }
    
    return false;
};

Npc.prototype.isPaintable = function(currentLocationElement, direction) {
    var Npc = this;
    var currentVector = new Vector(currentLocationElement);
    var newVector = Npc.getVector(currentVector, direction);

    if (newVector) {
        return Npc.character.painter.isPaintable(newVector, Npc);
    }

    return false;

};

Npc.prototype.getVector = function(currentVector, direction) {
    switch(direction) {
        case 38: 
            return currentVector.north();
        case 39: 
            return currentVector.east();
        case 40: 
            return currentVector.south();
        case 37: 
            return currentVector.west();
    }
};

Npc.prototype.moveRandom = function() {
    var randomDirection = null;
    var Npc = this;

    randomDirection = Util.randomItem(Npc.arrowKeys);
    Npc.character.move.direction(randomDirection);
};

Npc.prototype.currentScore = function() {
    return document.getElementsByClassName("npc-painted").length;
};

Npc.prototype.updateScore = function() {
    var Npc = this;
    Npc.score.innerHTML = Npc.currentScore();
};

Npc.prototype.stop = function() {
    var Npc = this;
    clearInterval(Npc.playing);
};
function Game(player, npc, timeLimit) {
    this.player = new Player(new Character(player));
    this.npc = new Npc(new Character(npc));
    this.space = new Space();

    this.cells = document.getElementsByClassName("cell");
    
    this.clock = {
        element: document.getElementById("clock"),
        timeElement: document.getElementById("clockTime"),
        timeLimit: timeLimit,
        timeLeft: timeLimit,
        running: null
    }

    this.startButton = {
        element: document.getElementById("start-button"),
        keys: [32, 13],
        handlers: []
    };
    
    this.countdown = {
        length: 3000,
        timeLeft: 3000,
        running: null
    }

    this.announcer = document.getElementById("announcer");

    this.init();
}

Game.prototype.init = function() {
    var Game = this;

    Game.space.make();
    Game.enableStartButton();
}

Game.prototype.start = function() {    
    var Game = this;

    Game.startClock();
    Game.player.play();
    Game.npc.play();
};

Game.prototype.startCountdown = function() {
    var Game = this;
    var announcer = Game.announcer;
    var countdown = Game.countdown;

    Game.reset();
    Game.disableButton(Game.startButton);
    announcer.className += ' ' + "show";
    
    announcer.innerHTML = '<span class="center countdown">' + (countdown.timeLeft / 1000)  + '</span>';

    countdown.running = setInterval(function() {
        Game.runCountdown();
    }, 1000);
};

Game.prototype.runCountdown = function() {   
    var timeLeft = this.countdown.timeLeft -= 1000;
    var Game = this;
    var announcer = Game.announcer;

    if (timeLeft === 0) {
        announcer.innerHTML = '<span class="center countdown">Go!</span>';
        Game.start();
    } else {
        announcer.innerHTML = '<span class="center countdown">' + (timeLeft / 1000)  + '</span>';
    }

    if (timeLeft === -1000) { 
        Game.stopCountdown();
    }
};

Game.prototype.stopCountdown = function() {
    var Game = this;

    clearInterval(Game.countdown.running);
    Util.removeClass(Game.announcer, "show");
    Game.announcer.innerHTML = "";
    Game.countdown.timeLeft = Game.countdown.length;
}

Game.prototype.startClock = function() {
    var Game = this;
    var infoPanel = Game.clock.element.parentElement;

    Util.removeClass(Game.clock.timeElement, "clock-stop");
    Game.clock.timeElement.innerHTML = (Game.clock.timeLimit / 1000) + "s";

    if ( Util.doesntHaveClass(infoPanel, "show") ) {
        infoPanel.className += ' ' + "show";
    }

    Game.clock.running = setInterval(function() {
        Game.runClock();
    }, 1000);
};

Game.prototype.runClock = function() {
    var Game = this;
    var clock = Game.clock;

    clock.timeLeft -= 1000;
    clock.timeElement.innerHTML = "<span>" + (clock.timeLeft / 1000)  + "s</span>";
    
    if (clock.timeLeft === 10000) {
        clock.timeElement.className += " clock-warning";
    }

    if (clock.timeLeft === 0) {
        Game.stopClock();
        Game.gameOver();
    }
};

Game.prototype.stopClock = function() {
    var clock = this.clock;

    clearInterval(clock.running);
    Util.removeClass(clock.timeElement, "clock-warning");
    clock.timeElement.className += " clock-stop";
}

Game.prototype.gameOver = function() {
    var Game = this;
    var Player = Game.player;
    var Npc = Game.npc;

    Player.stop();
    Npc.stop();
    
    Player.updateScore();
    Npc.updateScore();

    var playerScore = Player.currentScore();
    var npcScore = Npc.currentScore();

    if (playerScore > npcScore) {
        Game.announcer.innerHTML = "You win!";
        Game.winner(Game.player.character);
        Game.mouth("player-mouth", "smile");
        Game.mouth("npc-mouth", "frown");
    }

    if (playerScore < npcScore) {
        Game.announcer.innerHTML = "You lose!";
        Game.mouth("player-mouth", "frown");
        Game.winner(Game.npc.character);
        Game.mouth("npc-mouth", "smile");
    }

    if (playerScore === npcScore) {
        Game.announcer.innerHTML = "It's a tie!";
    }

    Game.enableStartButton();
};

Game.prototype.reset = function() {
    var Game = this;

    Game.resetCharacters();
    Game.resetBoard();
    Game.resetScore();
    Game.clock.timeLeft = Game.clock.timeLimit;
    Game.clock.timeElement.innerHTML = (Game.clock.timeLimit / 1000) + "s";
};

Game.prototype.resetCharacters = function() {
    var Game = this;

    Game.winner(false);
    Game.mouth("player-mouth", false);
    Game.mouth("npc-mouth", false);
    Game.cells[0].appendChild(Game.player.character.element);
    Game.cells[99].appendChild(Game.npc.character.element);
};

Game.prototype.resetBoard = function() {
    var Game = this; 

    var numOfCells = Game.cells.length;
    for (var i=0; i < numOfCells; i++) {
        Game.cells[i].className = "cell";
    }

    Game.announcer.innerHTML = "";
};

Game.prototype.resetScore = function() {
    var Game = this;

    Game.player.updateScore();
    Game.npc.updateScore();
};

Game.prototype.winner = function(character) {
    if (character === false) {
        var characters = document.getElementsByClassName("character");
        var numOfCharacters = characters.length;
        for (var i=0; i < numOfCharacters; i++) {
            Util.removeClass(characters[i], "winner");
        }
    } 

    else {
        character.element.className += " winner";
    }
}

Game.prototype.mouth = function(mouth, emotion) {
    var mouths = document.getElementsByClassName(mouth);
    var numberOfMouths = mouths.length;

    if (emotion === false) {
        for (var i=0; i < numberOfMouths; i++) {
            Util.removeClass(mouths[i], "smile");
            Util.removeClass(mouths[i], "frown");
        }
    } 

    else {
        for (var i=0; i < numberOfMouths; i++) {
            mouths[i].className += " " + emotion;
        }
    }
};

Game.prototype.enableStartButton = function(button) {
    Game = this;
    startButton = Game.startButton;
    Util.removeClass(startButton.element, "disabled");

    // == Add click event listener.
    startButton.handlers.push(
        EventHandler.addListener( "click", function() {
            Game.startCountdown();
        }, startButton.element)
    );

    // Add keydown event listener.
    startButton.handlers.push(
        EventHandler.addListener("keydown", function(e) {
            if (startButton.keys.indexOf(e.keyCode) > -1) {
                e.preventDefault();
                Game.startCountdown();                    
            }
        }, window)
    );

};

Game.prototype.disableButton = function(button) {
    var startButton = this.startButton;
    var numOfStartButtonHandlers = startButton.handlers.length;
    
    startButton.element.className += " disabled";
    
    // == Remove all startButton event listeners.
    for(i=0; i < numOfStartButtonHandlers; i++) {
        EventHandler.removeListener(startButton.handlers[i]);
    }
};