function Space(){this.canvas=document.getElementById("space"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.ctx=this.canvas.getContext("2d"),this.starsPerGalaxy=200,this.numberOfGalaxies=20,this.galaxySizes=[100,150,200,250,300],this.maxStarSize=2,this.numberOfStars=2e3}function Vector(e){this.element=e}function Move(e){this.element=e}function Painter(e){this.element=e,this.paintClass="painted",this.npcPaintClass="npc-painted"}function Character(e){this.element=document.getElementById(e),this.move=new Move(this.element),this.painter=new Painter(this.element)}function Player(e){this.character=e,this.score=document.getElementById("player-score"),this.movement={keys:[38,39,40,37],handlers:[]}}function Npc(e){this.character=e,this.vector=new Vector,this.arrowKeys=[38,39,40,37],this.speed=116,this.score=document.getElementById("npc-score"),this.playing=null}function Clock(e,t,n,r,a,o,i,s){this.element=document.getElementById(e),this.timeLimit=t,this.increment=n,this.stopAt=r,this.suffix=o,this.warning=i,this.stopAction=a,this.beforeStopAction=s,this.beforeStopAt=r+n,this.running,this.timeLeft=t}function Game(e,t,n){var r=this;r.player=new Player(new Character(e)),r.npc=new Npc(new Character(t)),r.space=new Space,r.cells=document.getElementsByClassName("cell"),r.startButton={element:document.getElementById("start-button"),keys:[32,13],handlers:[]},r.clock=new Clock("clock",n,1e3,0,function(){r.gameOver()},"s",1e4),r.countdown=new Clock("announcer",3e3,1e3,(-1e3),function(){r.clearCountdown()},"","",function(){r.go()}),r.announcer=document.getElementById("announcer"),r.space.make(),r.enableStartButton()}var Util=function(){return{childIndex:function(e,t){for(var n=t.length,r=0;r<n;++r)if(e===t[r])return r},hasClass:function(e,t){return(" "+e.className+" ").indexOf(" "+t+" ")>-1},doesntHaveClass:function(e,t){var n=this;return!n.hasClass(e,t)},randomItem:function(e){var t=this;return e[t.randomNumber(e.length)]},removeClass:function(e,t){var n=this;n.hasClass(e,t)&&e.classList.remove(t)},shuffleArray:function(e){var t,n,r,a=this;for(r=e.length;r;r--)t=a.randomNumber(r),n=e[r-1],e[r-1]=e[t],e[t]=n;return e},randomNumber:function(e){var t=Math.floor(Math.random()*e);return 0===t?1:t}}}(),EventHandler=function(){var e=0,t=[];return{addListener:function(n,r,a){return e++,a.addEventListener(n,r),t[e]={event:n,handler:r,element:a},e},removeListener:function(e){if(e in t){var n=t[e];n.element.removeEventListener(n.event,n.handler),delete t[e]}}}}();Space.prototype.make=function(){for(var e=this,t=e.numberOfStars,n=e.numberOfGalaxies,r=0;r<t;r++)e.star();for(var r=0;r<n;r++)e.galaxy()},Space.prototype.star=function(e,t){var n=this,r=n.ctx,a=n.canvas,o=Util.randomNumber(n.maxStarSize),e=e,t=t;void 0===e&&(e=Util.randomNumber(a.width)),void 0===t&&(t=Util.randomNumber(a.height)),r.fillStyle="rgba(255, 255, 255,"+1/Util.randomNumber(10)+")",r.beginPath(),r.arc(e,t,o,0,2*Math.PI,!0),r.closePath(),r.fill()},Space.prototype.galaxy=function(){var e=this,t=Util.randomNumber(e.canvas.width),n=Util.randomNumber(e.canvas.height);e.galaxyStars(t,n)},Space.prototype.galaxyStars=function(e,t){for(var n,r,a=this,o=a.ctx,i=e,s=t,c=Util.randomItem(a.galaxySizes),l=0;l<a.starsPerGalaxy;l++)xAmount=Util.randomNumber(c),0===Util.randomNumber(2)&&(xAmount=-Math.abs(xAmount)),n=i+xAmount*Math.LN10,yAmount=Util.randomNumber(c),0===Util.randomNumber(2)&&(yAmount=-Math.abs(yAmount)),r=s+yAmount+Math.LN10,o.moveTo(n,r),a.star(n,r)},Vector.prototype.north=function(){var e=this,t=e.element.parentElement,n=t.parentElement,r=n.children,a=Util.childIndex(t,r),o=n.previousElementSibling;if(o)return o.children[a]},Vector.prototype.east=function(){var e=this;return e.element.parentElement.nextElementSibling},Vector.prototype.south=function(){var e=this,t=e.element.parentElement,n=t.parentElement,r=n.children,a=Util.childIndex(t,r),o=n.nextElementSibling;if(o)return o.children[a]},Vector.prototype.west=function(){var e=this;return e.element.parentElement.previousElementSibling},Move.prototype.direction=function(e){var t=this,n=t.element;switch(e){case 38:t.north(new Vector(n));break;case 39:t.east(new Vector(n));break;case 40:t.south(new Vector(n));break;case 37:t.west(new Vector(n))}},Move.prototype.north=function(e){var t=e.north();t&&t.appendChild(e.element)},Move.prototype.east=function(e){var t=e.east();t&&t.appendChild(e.element)},Move.prototype.south=function(e){var t=e.south();t&&t.appendChild(e.element)},Move.prototype.west=function(e){var t=e.west();t&&t.appendChild(e.element)},Painter.prototype.paint=function(){var e=this;e.removePaint(e.npcPaintClass),Util.doesntHaveClass(e.element.parentElement,e.paintClass)&&(e.element.parentElement.className+=" "+e.paintClass)},Painter.prototype.removePaint=function(e){Util.removeClass(this.element.parentElement,e)},Painter.prototype.npcPaint=function(){var e=this;e.removePaint(e.paintClass),Util.doesntHaveClass(e.element.parentElement,e.npcPaintClass)&&(e.element.parentElement.className+=" "+e.npcPaintClass)},Painter.prototype.isPaintable=function(e,t){var n,r=this;return t instanceof Npc&&(n=r.npcPaintClass),t instanceof Player&&(n=r.paintClass),Util.doesntHaveClass(e,n)},Player.prototype.play=function(){var e=this;e.enableMovement()},Player.prototype.enableMovement=function(){var e=this,t=!0,n=e.movement;n.handlers.push(EventHandler.addListener("keydown",function(r){if(n.keys.indexOf(r.keyCode)>-1){if(r.preventDefault(),!t)return r.keyCode;t=!1,e.character.move.direction(r.keyCode),e.character.painter.paint(),e.updateScore()}},window)),n.handlers.push(EventHandler.addListener("keyup",function(e){n.keys.indexOf(e.keyCode)>-1&&(t=!0)},window))},Player.prototype.disableMovement=function(){var e=this,t=e.movement.handlers.length;for(i=0;i<t;i++)EventHandler.removeListener(e.movement.handlers[i])},Player.prototype.currentScore=function(){return document.getElementsByClassName("painted").length},Player.prototype.updateScore=function(){var e=this;e.score.innerHTML=e.currentScore()},Player.prototype.stop=function(){var e=this;e.disableMovement()},Npc.prototype.play=function(){var e=this;e.playing=setInterval(function(){e.move(),e.character.painter.npcPaint(),e.updateScore()},e.speed)},Npc.prototype.move=function(){var e=this,t=e.look(e.character.element);t===!1?e.moveRandom():e.character.move.direction(t)},Npc.prototype.look=function(e){for(var t,n=this,r=n.arrowKeys.length,a=Util.shuffleArray(n.arrowKeys),o=0;o<r;o++)if(t=n.isPaintable(e,a[o]))return a[o];return!1},Npc.prototype.isPaintable=function(e,t){var n=this,r=new Vector(e),a=n.getVector(r,t);return!!a&&n.character.painter.isPaintable(a,n)},Npc.prototype.getVector=function(e,t){switch(t){case 38:return e.north();case 39:return e.east();case 40:return e.south();case 37:return e.west()}},Npc.prototype.moveRandom=function(){var e=null,t=this;e=Util.randomItem(t.arrowKeys),t.character.move.direction(e)},Npc.prototype.currentScore=function(){return document.getElementsByClassName("npc-painted").length},Npc.prototype.updateScore=function(){var e=this;e.score.innerHTML=e.currentScore()},Npc.prototype.stop=function(){var e=this;clearInterval(e.playing)},Clock.prototype.start=function(){var e=this;e.running=setInterval(function(){e.runClock()},e.increment)},Clock.prototype.runClock=function(){var e=this;e.timeLeft-=e.increment,e.element.innerHTML='<span class="clock-time">'+e.timeLeft/e.increment+e.suffix+"</span>",e.timeLeft===e.warning&&(e.element.className+=" clock-warning"),"function"==typeof e.beforeStopAction&&e.timeLeft===e.beforeStopAt&&e.beforeStopAction(),e.timeLeft===e.stopAt&&e.stopClock()},Clock.prototype.stopClock=function(){var e=this;clearInterval(e.running),Util.removeClass(e.element,"clock-warning"),e.element.className+=" clock-stop","function"==typeof e.stopAction&&e.stopAction(),e.timeLeft=e.timeLimit},Game.prototype.start=function(){var e=this,t=e.announcer,n=e.clock.element.parentElement.parentElement;Util.doesntHaveClass(n,"show")&&(n.className+=" show"),e.reset(),e.disableButton(e.startButton),t.className+=" show",t.innerHTML='<span class="clock-time">'+e.countdown.timeLimit/e.countdown.increment+"</span>",e.countdown.start()},Game.prototype.go=function(){var e=this;Util.removeClass(e.clock.element,"clock-stop"),e.announcer.innerHTML='<span class="clock-time">GO!</span>',e.play()},Game.prototype.clearCountdown=function(){var e=this;Util.removeClass(e.announcer,"show"),Util.removeClass(e.announcer,"clock-stop"),e.announcer.innerHTML=""},Game.prototype.play=function(){var e=this;e.clock.start(),e.player.play(),e.npc.play()},Game.prototype.gameOver=function(){var e=this,t=e.player,n=e.npc;e.announcer.className+=" frame show",t.stop(),n.stop(),t.updateScore(),n.updateScore();var r=t.currentScore(),a=n.currentScore();r>a&&(e.announcer.innerHTML='<div class="center announce-won">You win! =)</div>',e.winner(e.player.character),e.mouth("player-mouth","smile"),e.mouth("npc-mouth","frown")),r<a&&(e.announcer.innerHTML='<div class="center announce-lost">You lose! =(</div>',e.mouth("player-mouth","frown"),e.winner(e.npc.character),e.mouth("npc-mouth","smile")),r===a&&(e.announcer.innerHTML="It's a tie!"),e.enableStartButton()},Game.prototype.reset=function(){var e=this;e.resetCharacters(),e.resetBoard(),e.resetScore(),Util.removeClass(announcer,"frame"),e.clock.timeLeft=e.clock.timeLimit,e.clock.element.innerHTML=e.clock.timeLimit/1e3+"s"},Game.prototype.resetCharacters=function(){var e=this,t=e.player.character.element,n=e.npc.character.element;e.winner(!1),e.mouth("player-mouth",!1),e.mouth("npc-mouth",!1),e.cells[0].appendChild(t),e.cells[99].appendChild(n)},Game.prototype.resetBoard=function(){for(var e=this,t=e.cells.length,n=e.cells,r=0;r<t;r++)n[r].className="cell";e.announcer.innerHTML=""},Game.prototype.resetScore=function(){var e=this;e.player.updateScore(),e.npc.updateScore()},Game.prototype.winner=function(e){if(e===!1)for(var t=document.getElementsByClassName("character"),n=t.length,r=0;r<n;r++)Util.removeClass(t[r],"winner");else e.element.className+=" winner"},Game.prototype.mouth=function(e,t){var n=document.getElementsByClassName(e),r=n.length;if(t===!1)for(var a=0;a<r;a++)Util.removeClass(n[a],"smile"),Util.removeClass(n[a],"frown");else for(var a=0;a<r;a++)n[a].className+=" "+t},Game.prototype.enableStartButton=function(e){Game=this,startButton=Game.startButton,Util.removeClass(startButton.element,"disabled"),startButton.handlers.push(EventHandler.addListener("click",function(){Game.start()},startButton.element)),startButton.handlers.push(EventHandler.addListener("keydown",function(e){startButton.keys.indexOf(e.keyCode)>-1&&(e.preventDefault(),Game.start())},window))},Game.prototype.disableButton=function(e){var t=this.startButton,n=t.handlers.length;for(t.element.className+=" disabled",i=0;i<n;i++)EventHandler.removeListener(t.handlers[i])};