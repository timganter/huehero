function Space(){var e=this;e.canvas=document.getElementById("space"),e.canvas.width=window.innerWidth,e.canvas.height=window.innerHeight,e.ctx=e.canvas.getContext("2d"),e.starsPerGalaxy=200,e.numberOfGalaxies=20,e.galaxySizes=[100,150,200,250,300],e.maxStarSize=2,e.numberOfStars=2e3,e.setListeners()}function Audio(){var e=this;e.title=document.getElementById("audioTitle"),e.title.loop=!0,e.gamePlay=document.getElementById("audioGamePlay"),e.gamePlayFast=document.getElementById("audioGamePlayFast"),e.gameOver=document.getElementById("audioGameOver"),e.gameOver.loop=!0,e.youLose=document.getElementById("audioYouLose"),e.youWin=document.getElementById("audioYouWin"),e.setListeners()}function Vector(e){this.element=e}function Move(e){this.element=e}function Painter(e){this.element=e,this.paintClass="painted",this.npcPaintClass="npc-painted"}function Character(e){this.element=document.getElementById(e),this.move=new Move(this.element),this.painter=new Painter(this.element)}function Player(e){this.character=e,this.score=document.getElementById("player-score"),this.movement={keys:[38,39,40,37],handlers:[]}}function Npc(e){this.character=e,this.vector=new Vector,this.arrowKeys=[38,39,40,37],this.speed=120,this.score=document.getElementById("npc-score"),this.playing=null}function Clock(e,t,n,a,r,o,i,s,c){this.element=document.getElementById(e),this.timeLimit=t,this.increment=n,this.stopAt=a,this.stopAction=r,this.suffix=o,this.warning=i,this.warningAction=s,this.beforeStopAction=c,this.beforeStopAt=a+n,this.running,this.timeLeft=t}function Game(e,t,n){var a=this;a.player=new Player(new Character(e)),a.npc=new Npc(new Character(t)),a.space=new Space,a.audio=new Audio,a.cells=document.getElementsByClassName("cell"),a.startButton={element:document.getElementById("start-button"),keys:[32,13],handlers:[]},a.clock=new Clock("clock",n,1e3,0,function(){a.gameOver()},"s",1e4,function(){a.timeAlmostUp()}),a.countdown=new Clock("announcer",2e3,1e3,(-1e3),function(){a.clearCountdown()},"","","",function(){a.go()}),a.announcer=document.getElementById("announcer"),a.space.make(),a.enableStartButton(),a.audio.title.play()}var Util=function(){return{childIndex:function(e,t){for(var n=t.length,a=0;a<n;++a)if(e===t[a])return a},hasClass:function(e,t){return(" "+e.className+" ").indexOf(" "+t+" ")>-1},doesntHaveClass:function(e,t){var n=this;return!n.hasClass(e,t)},randomItem:function(e){var t=this;return e[t.randomNumber(e.length)]},removeClass:function(e,t){var n=this;n.hasClass(e,t)&&e.classList.remove(t)},shuffleArray:function(e){var t,n,a,r=this;for(a=e.length;a;a--)t=r.randomNumber(a),n=e[a-1],e[a-1]=e[t],e[t]=n;return e},randomNumber:function(e){var t=Math.floor(Math.random()*e);return 0===t?1:t}}}(),EventHandler=function(){var e=0,t=[];return{addListener:function(n,a,r){return e++,r.addEventListener(n,a),t[e]={event:n,handler:a,element:r},e},removeListener:function(e){if(e in t){var n=t[e];n.element.removeEventListener(n.event,n.handler),delete t[e]}}}}();Space.prototype.make=function(){for(var e=this,t=e.numberOfStars,n=e.numberOfGalaxies,a=0;a<t;a++)e.star();for(var a=0;a<n;a++)e.galaxy()},Space.prototype.star=function(e,t){var n=this,a=n.ctx,r=n.canvas,o=Util.randomNumber(n.maxStarSize),e=e,t=t;void 0===e&&(e=Util.randomNumber(r.width)),void 0===t&&(t=Util.randomNumber(r.height)),a.fillStyle="rgba(255, 255, 255,"+1/Util.randomNumber(10)+")",a.beginPath(),a.arc(e,t,o,0,2*Math.PI,!0),a.closePath(),a.fill()},Space.prototype.galaxy=function(){var e=this,t=Util.randomNumber(e.canvas.width),n=Util.randomNumber(e.canvas.height);e.galaxyStars(t,n)},Space.prototype.galaxyStars=function(e,t){for(var n,a,r=this,o=r.ctx,i=e,s=t,c=Util.randomItem(r.galaxySizes),l=0;l<r.starsPerGalaxy;l++)xAmount=Util.randomNumber(c),0===Util.randomNumber(2)&&(xAmount=-Math.abs(xAmount)),n=i+xAmount*Math.LN10,yAmount=Util.randomNumber(c),0===Util.randomNumber(2)&&(yAmount=-Math.abs(yAmount)),a=s+yAmount+Math.LN10,o.moveTo(n,a),r.star(n,a)},Space.prototype.setListeners=function(){var e=this;EventHandler.addListener("resize",function(t){e.canvas.width=window.innerWidth,e.canvas.height=window.innerHeight,e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.make()},window)},Audio.prototype.setListeners=function(){var e=this;EventHandler.addListener("ended",function(t){e.gameOver.play(),e.reset()},e.youLose),EventHandler.addListener("ended",function(t){e.gameOver.play(),e.reset(),e.youWin.currentTime=0},e.youWin)},Audio.prototype.playGame=function(){var e=this;e.pauseAll(),e.reset(),e.gamePlay.play()},Audio.prototype.pauseAll=function(){var e=this;e.title.pause(),e.gamePlay.pause(),e.gamePlayFast.pause(),e.gameOver.pause(),e.youLose.pause(),e.youWin.pause()},Audio.prototype.reset=function(){var e=this;e.title.currentTime=0,e.gamePlay.currentTime=0,e.gamePlayFast.currentTime=0,e.gameOver.currentTime=0,e.youLose.currentTime=0,e.youWin.currentTime=0},Vector.prototype.north=function(){var e=this,t=e.element.parentElement,n=t.parentElement,a=n.children,r=Util.childIndex(t,a),o=n.previousElementSibling;if(o)return o.children[r]},Vector.prototype.east=function(){var e=this;return e.element.parentElement.nextElementSibling},Vector.prototype.south=function(){var e=this,t=e.element.parentElement,n=t.parentElement,a=n.children,r=Util.childIndex(t,a),o=n.nextElementSibling;if(o)return o.children[r]},Vector.prototype.west=function(){var e=this;return e.element.parentElement.previousElementSibling},Move.prototype.direction=function(e){var t=this,n=t.element;switch(e){case 38:t.north(new Vector(n));break;case 39:t.east(new Vector(n));break;case 40:t.south(new Vector(n));break;case 37:t.west(new Vector(n))}},Move.prototype.north=function(e){var t=e.north();t&&t.appendChild(e.element)},Move.prototype.east=function(e){var t=e.east();t&&t.appendChild(e.element)},Move.prototype.south=function(e){var t=e.south();t&&t.appendChild(e.element)},Move.prototype.west=function(e){var t=e.west();t&&t.appendChild(e.element)},Painter.prototype.paint=function(){var e=this;e.removePaint(e.npcPaintClass),Util.doesntHaveClass(e.element.parentElement,e.paintClass)&&(e.element.parentElement.className+=" "+e.paintClass)},Painter.prototype.removePaint=function(e){Util.removeClass(this.element.parentElement,e)},Painter.prototype.npcPaint=function(){var e=this;e.removePaint(e.paintClass),Util.doesntHaveClass(e.element.parentElement,e.npcPaintClass)&&(e.element.parentElement.className+=" "+e.npcPaintClass)},Painter.prototype.isPaintable=function(e,t){var n,a=this;return t instanceof Npc&&(n=a.npcPaintClass),t instanceof Player&&(n=a.paintClass),Util.doesntHaveClass(e,n)},Player.prototype.play=function(){var e=this;e.enableMovement()},Player.prototype.enableMovement=function(){var e=this,t=!0,n=e.movement;n.handlers.push(EventHandler.addListener("keydown",function(a){if(n.keys.indexOf(a.keyCode)>-1){if(a.preventDefault(),!t)return a.keyCode;t=!1,e.character.move.direction(a.keyCode),e.character.painter.paint(),e.updateScore()}},window)),n.handlers.push(EventHandler.addListener("keyup",function(e){n.keys.indexOf(e.keyCode)>-1&&(t=!0)},window))},Player.prototype.disableMovement=function(){var e=this,t=e.movement.handlers.length;for(i=0;i<t;i++)EventHandler.removeListener(e.movement.handlers[i])},Player.prototype.currentScore=function(){return document.getElementsByClassName("painted").length},Player.prototype.updateScore=function(){var e=this;e.score.innerHTML=e.currentScore()},Player.prototype.stop=function(){var e=this;e.disableMovement()},Npc.prototype.play=function(){var e=this;e.playing=setInterval(function(){e.move(),e.character.painter.npcPaint(),e.updateScore()},e.speed)},Npc.prototype.move=function(){var e=this,t=e.look(e.character.element);t===!1?e.moveRandom():e.character.move.direction(t)},Npc.prototype.look=function(e){for(var t,n=this,a=n.arrowKeys.length,r=Util.shuffleArray(n.arrowKeys),o=0;o<a;o++)if(t=n.isPaintable(e,r[o]))return r[o];return!1},Npc.prototype.isPaintable=function(e,t){var n=this,a=new Vector(e),r=n.getVector(a,t);return!!r&&n.character.painter.isPaintable(r,n)},Npc.prototype.getVector=function(e,t){switch(t){case 38:return e.north();case 39:return e.east();case 40:return e.south();case 37:return e.west()}},Npc.prototype.moveRandom=function(){var e=null,t=this;e=Util.randomItem(t.arrowKeys),t.character.move.direction(e)},Npc.prototype.currentScore=function(){return document.getElementsByClassName("npc-painted").length},Npc.prototype.updateScore=function(){var e=this;e.score.innerHTML=e.currentScore()},Npc.prototype.stop=function(){var e=this;clearInterval(e.playing)},Clock.prototype.start=function(){var e=this;e.running=setInterval(function(){e.runClock()},e.increment)},Clock.prototype.runClock=function(){var e=this;e.timeLeft-=e.increment,e.element.innerHTML='<span class="clock-time">'+e.timeLeft/e.increment+e.suffix+"</span>",e.timeLeft===e.warning&&(e.element.className+=" clock-warning","function"==typeof e.warningAction&&e.warningAction()),"function"==typeof e.beforeStopAction&&e.timeLeft===e.beforeStopAt&&e.beforeStopAction(),e.timeLeft===e.stopAt&&e.stopClock()},Clock.prototype.stopClock=function(){var e=this;clearInterval(e.running),Util.removeClass(e.element,"clock-warning"),e.element.className+=" clock-stop","function"==typeof e.stopAction&&e.stopAction(),e.timeLeft=e.timeLimit},Game.prototype.start=function(){var e=this,t=e.announcer,n=e.clock.element.parentElement.parentElement,a=e.audio;a.playGame(),Util.doesntHaveClass(n,"show")&&(n.className+=" show"),e.reset(),e.disableButton(e.startButton),t.className+=" show",t.innerHTML='<span class="clock-time">'+e.countdown.timeLimit/e.countdown.increment+"</span>",e.countdown.start()},Game.prototype.go=function(){var e=this;Util.removeClass(e.clock.element,"clock-stop"),e.announcer.innerHTML='<span class="clock-time">GO!</span>',e.play()},Game.prototype.clearCountdown=function(){var e=this;Util.removeClass(e.announcer,"show"),Util.removeClass(e.announcer,"clock-stop"),e.announcer.innerHTML=""},Game.prototype.play=function(){var e=this;e.clock.start(),e.player.play(),e.npc.play()},Game.prototype.timeAlmostUp=function(){var e=Game.audio;e.gamePlay.pause(),e.gamePlay.currentTime=0,e.gamePlayFast.play()},Game.prototype.gameOver=function(){var e=this,t=e.player,n=e.npc;e.announcer.className+=" frame show",t.stop(),n.stop(),t.updateScore(),n.updateScore();var a=t.currentScore(),r=n.currentScore(),o=e.audio;o.gamePlayFast.pause(),o.gamePlayFast.currentTime=0,a>r&&(e.announcer.innerHTML='<div class="center announce-won">You win! =)</div>',e.winner(e.player.character),e.mouth("player-mouth","smile"),e.mouth("npc-mouth","frown"),o.youWin.play()),a<r&&(e.announcer.innerHTML='<div class="center announce-lost">You lose! =(</div>',e.mouth("player-mouth","frown"),e.winner(e.npc.character),e.mouth("npc-mouth","smile"),o.youLose.play()),a===r&&(e.announcer.innerHTML="It's a tie!"),e.enableStartButton()},Game.prototype.reset=function(){var e=this;e.resetCharacters(),e.resetBoard(),e.resetScore(),Util.removeClass(announcer,"frame"),e.clock.timeLeft=e.clock.timeLimit,e.clock.element.innerHTML=e.clock.timeLimit/1e3+"s"},Game.prototype.resetCharacters=function(){var e=this,t=e.player.character.element,n=e.npc.character.element;e.winner(!1),e.mouth("player-mouth",!1),e.mouth("npc-mouth",!1),e.cells[0].appendChild(t),e.cells[99].appendChild(n)},Game.prototype.resetBoard=function(){for(var e=this,t=e.cells.length,n=e.cells,a=0;a<t;a++)n[a].className="cell";e.announcer.innerHTML=""},Game.prototype.resetScore=function(){var e=this;e.player.updateScore(),e.npc.updateScore()},Game.prototype.winner=function(e){if(e===!1)for(var t=document.getElementsByClassName("character"),n=t.length,a=0;a<n;a++)Util.removeClass(t[a],"winner");else e.element.className+=" winner"},Game.prototype.mouth=function(e,t){var n=document.getElementsByClassName(e),a=n.length;if(t===!1)for(var r=0;r<a;r++)Util.removeClass(n[r],"smile"),Util.removeClass(n[r],"frown");else for(var r=0;r<a;r++)n[r].className+=" "+t},Game.prototype.enableStartButton=function(e){Game=this,startButton=Game.startButton,Util.removeClass(startButton.element,"disabled"),startButton.handlers.push(EventHandler.addListener("click",function(){Game.start()},startButton.element)),startButton.handlers.push(EventHandler.addListener("keydown",function(e){startButton.keys.indexOf(e.keyCode)>-1&&(e.preventDefault(),Game.start())},window))},Game.prototype.disableButton=function(e){var t=this.startButton,n=t.handlers.length;for(t.element.className+=" disabled",i=0;i<n;i++)EventHandler.removeListener(t.handlers[i])};